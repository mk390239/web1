<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ãƒãƒ¼ã‚«ãƒ¼èµ·å‹•ï¼‹ç©ºé–“å›ºå®šAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: AR.js ãƒãƒ¼ã‚«ãƒ¼èªè­˜ãƒ¢ãƒ¼ãƒ‰ -->
    <a-scene 
        id="ar-scene"
        embedded 
        arjs 
        vr-mode-ui="enabled: false"
        style="display: block;"
    >
        <a-marker preset="hiro" id="starter-marker">
            <a-entity 
                id="trigger-entity"
                visible="false"
            ></a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>
    
    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
    <a-scene 
        id="device-scene"
        vr-mode-ui="enabled: false"
        style="display: none;"
    >
        <a-entity
            id="world-model"
            gltf-model="4.glb"
            scale="0.01 0.01 0.01"
            position="0 0 -1.5"
            visible="true"
        ></a-entity>
        
        <!-- èƒŒæ™¯ã‚’ç¾å®Ÿã®ã‚«ãƒ¡ãƒ©æ˜ åƒã« -->
        <a-entity geometry="primitive: plane; height: 20; width: 20" 
                  material="shader: flat; src: #camera-texture;"
                  position="0 0 -5"
                  rotation="0 0 0"></a-entity>
        
        <a-entity
            camera
            look-controls="enabled: false"
            wasd-controls="enabled: false"
            position="0 0 0"
        ></a-entity>
    </a-scene>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ†ã‚¯ã‚¹ãƒãƒ£ç”¨ -->
    <video id="camera-video" autoplay style="display: none; width: 100px; height: 100px;"></video>
    
    <!-- ç”»é¢è¡¨ç¤º -->
    <div id="instruction" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; font-family: 'Hiragino Sans', sans-serif; z-index: 1000; pointer-events: none;">
        <div style="background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px;">
            <div style="font-size: 24px; margin-bottom: 20px;">ğŸ¯ ARä½“é¨“</div>
            <div id="step1" style="font-size: 18px;">
                1. Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„
            </div>
            <div id="step2" style="font-size: 18px; display: none;">
                2. ã‚¹ãƒãƒ›ã‚’å‹•ã‹ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã¦å›ã‚Œã¾ã™
            </div>
        </div>
    </div>

    <script>
        let isARStarted = false;
        let cameraStream = null;
        
        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºæ™‚ã®å‡¦ç†
        document.querySelector('#starter-marker').addEventListener('markerFound', function() {
            if (!isARStarted) {
                startARExperience();
            }
        });
        
        async function startARExperience() {
            isARStarted = true;
            
            // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦è¨­å®š
                const video = document.getElementById('camera-video');
                video.srcObject = cameraStream;
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // ã‚·ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('ar-scene').style.display = 'none';
            document.getElementById('device-scene').style.display = 'block';
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            document.getElementById('instruction').style.top = '20px';
            document.getElementById('instruction').style.transform = 'translate(-50%, 0)';
            
            // ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹åŒ–
            enableDeviceOrientation();
            
            console.log('ğŸš€ ARä½“é¨“ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
            console.log('ğŸ“± ã‚¹ãƒãƒ›ã‚’å‹•ã‹ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’è¦³å¯Ÿã—ã¦ãã ã•ã„');
        }
        
        function enableDeviceOrientation() {
            const camera = document.querySelector('#device-scene [camera]');
            
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            setupDeviceOrientation(camera);
                        }
                    })
                    .catch(console.error);
            } else {
                // Android
                setupDeviceOrientation(camera);
            }
        }
        
        function setupDeviceOrientation(camera) {
            let initialAlpha = null;
            let isCalibrated = false;
            
            window.addEventListener('deviceorientation', (event) => {
                if (!isCalibrated) {
                    initialAlpha = event.alpha;
                    isCalibrated = true;
                    return;
                }
                
                const alpha = event.alpha - (initialAlpha || 0);
                const beta = event.beta;
                const gamma = event.gamma;
                
                // ã‚«ãƒ¡ãƒ©ã®å›è»¢ã‚’ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã«é€£å‹•
                camera.setAttribute('rotation', {
                    x: THREE.MathUtils.clamp(beta - 90, -180, 180),
                    y: THREE.MathUtils.clamp(alpha, -180, 180),
                    z: THREE.MathUtils.clamp(-gamma, -45, 45)
                });
            });
            
            console.log('âœ… ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
        }
        
        // ãƒ¢ãƒ‡ãƒ«æ“ä½œæ©Ÿèƒ½
        AFRAME.registerComponent('model-controls', {
            init: function() {
                this.model = this.el;
                this.initialScale = 0.01;
                this.currentScale = this.initialScale;
                this.setupInteractions();
            },
            
            setupInteractions: function() {
                const scene = this.model.sceneEl;
                
                // ã‚¿ãƒƒãƒæ“ä½œ
                let isRotating = false;
                let lastTouchX = 0;
                let initialPinchDistance = 0;
                let initialScale = this.initialScale;
                
                scene.addEventListener('touchstart', (evt) => {
                    if (evt.touches.length === 1) {
                        isRotating = true;
                        lastTouchX = evt.touches[0].clientX;
                    }
                    
                    if (evt.touches.length === 2) {
                        initialPinchDistance = this.getTouchDistance(evt.touches);
                        initialScale = this.currentScale;
                    }
                });
                
                scene.addEventListener('touchmove', (evt) => {
                    evt.preventDefault();
                    
                    // å›è»¢
                    if (isRotating && evt.touches.length === 1) {
                        const deltaX = evt.touches[0].clientX - lastTouchX;
                        const currentRotation = this.model.getAttribute('rotation');
                        this.model.setAttribute('rotation', {
                            x: currentRotation.x,
                            y: currentRotation.y + deltaX * 0.5,
                            z: currentRotation.z
                        });
                        lastTouchX = evt.touches[0].clientX;
                    }
                    
                    // ã‚¹ã‚±ãƒ¼ãƒ«
                    if (evt.touches.length === 2) {
                        const currentDistance = this.getTouchDistance(evt.touches);
                        const scaleRatio = currentDistance / initialPinchDistance;
                        this.currentScale = Math.max(0.005, Math.min(0.05, initialScale * scaleRatio));
                        this.model.setAttribute('scale', {
                            x: this.currentScale,
                            y: this.currentScale,
                            z: this.currentScale
                        });
                    }
                });
                
                scene.addEventListener('touchend', () => {
                    isRotating = false;
                });
            },
            
            getTouchDistance: function(touches) {
                const dx = touches[0].clientX - touches[1].clientX;
                const dy = touches[0].clientY - touches[1].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        });
        
        // ã‚«ãƒ¡ãƒ©ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼
        AFRAME.registerShader('flat', {
            schema: {
                src: {type: 'map', is: 'uniform'}
            },
            init: function (data) {
                const texture = new THREE.VideoTexture(document.getElementById('camera-video'));
                texture.minFilter = THREE.LinearFilter;
                
                this.material = new THREE.MeshBasicMaterial({
                    map: texture,
                    side: THREE.DoubleSide
                });
            }
        });
        
        // åˆæœŸåŒ–
        window.addEventListener('load', function() {
            const model = document.querySelector('#world-model');
            model.setAttribute('model-controls', '');
            
            console.log('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼èµ·å‹•ï¼‹ç©ºé–“å›ºå®šAR æº–å‚™å®Œäº†');
            console.log('ğŸ“± Hiroãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„');
        });
    </script>
    
    <style>
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: #000;
            margin: 0;
            padding: 0;
        }
        
        a-scene {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</body>
</html>
